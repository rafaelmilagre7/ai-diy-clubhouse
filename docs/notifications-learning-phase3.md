# üìö Fase 3: Sistema de Notifica√ß√µes - Cobertura Forma√ß√µes (Learning/LMS)

## üéØ Objetivo

Implementar notifica√ß√µes completas para todos os eventos relacionados ao sistema de aprendizagem (Learning/LMS), garantindo que os usu√°rios sejam informados sobre novos cursos, progresso, certificados e intera√ß√µes.

## üìã Eventos Cobertos

### 1. **Novos Cursos Publicados** (`learning_course_published`)
- **Quando:** Curso muda de `draft` para `published`
- **Quem recebe:** Todos os membros ativos da organiza√ß√£o
- **Prioridade:** M√©dia
- **Trigger:** `trigger_notify_new_course_published`

### 2. **Nova Aula Dispon√≠vel** (`learning_lesson_available`)
- **Quando:** Aula √© publicada em curso que o usu√°rio j√° est√° fazendo
- **Quem recebe:** Usu√°rios com progresso no curso
- **Prioridade:** M√©dia
- **Trigger:** `trigger_notify_new_lesson_available`

### 3. **M√≥dulo Desbloqueado** (`learning_module_unlocked`)
- **Quando:** Usu√°rio completa todas as aulas de um m√≥dulo
- **Quem recebe:** Usu√°rio que completou o m√≥dulo
- **Prioridade:** Alta
- **Trigger:** `trigger_notify_module_unlocked`

### 4. **Certificado Pronto** (`learning_certificate_ready`)
- **Quando:** Certificado √© gerado e URL disponibilizada
- **Quem recebe:** Usu√°rio que completou o curso
- **Prioridade:** Alta
- **Trigger:** `trigger_notify_certificate_ready`

### 5. **Lembrete de Curso Inacabado** (`learning_course_reminder`)
- **Quando:** 7 dias sem progresso em curso iniciado (5-95% completo)
- **Quem recebe:** Usu√°rio com curso inacabado
- **Prioridade:** M√©dia
- **Edge Function:** `process-course-reminders` (cron di√°rio)

### 6. **Milestone Atingido** (`learning_milestone_reached`)
- **Quando:** Progresso atinge 25%, 50% ou 75% do curso
- **Quem recebe:** Usu√°rio que atingiu o milestone
- **Prioridade:** M√©dia
- **RPC Function:** `check_course_milestones` (chamada ao completar aula)

### 7. **Resposta em Coment√°rio** (`learning_comment_reply`)
- **Quando:** Algu√©m responde um coment√°rio em uma aula
- **Quem recebe:** Autor do coment√°rio original
- **Prioridade:** Baixa
- **Trigger:** `trigger_notify_learning_comment_reply`

### 8. **Recomenda√ß√£o de Curso** (`learning_course_recommendation`)
- **Quando:** Sistema identifica curso relevante para o usu√°rio
- **Quem recebe:** Usu√°rio que pode se interessar
- **Prioridade:** Baixa
- **Edge Function:** `recommend-courses`

### 9. **Conte√∫do Atualizado** (`learning_content_updated`)
- **Quando:** Aula tem t√≠tulo, conte√∫do ou recursos atualizados
- **Quem recebe:** Usu√°rios matriculados no curso
- **Prioridade:** Baixa
- **Trigger:** `trigger_notify_course_content_updated`

### 10. **Teste Dispon√≠vel** (`learning_test_available`)
- **Quando:** Teste √© liberado para o usu√°rio
- **Quem recebe:** Usu√°rio eleg√≠vel para fazer o teste
- **Prioridade:** M√©dia
- **Implementa√ß√£o:** A ser definida (depende do sistema de testes)

## üîß Implementa√ß√£o T√©cnica

### Database Triggers

```sql
-- 1. Novo curso publicado
CREATE TRIGGER trigger_notify_new_course_published
  AFTER UPDATE ON learning_courses
  FOR EACH ROW
  EXECUTE FUNCTION notify_new_course_published();

-- 2. Nova aula dispon√≠vel
CREATE TRIGGER trigger_notify_new_lesson_available
  AFTER UPDATE ON learning_lessons
  FOR EACH ROW
  EXECUTE FUNCTION notify_new_lesson_available();

-- 3. M√≥dulo desbloqueado
CREATE TRIGGER trigger_notify_module_unlocked
  AFTER UPDATE ON learning_progress
  FOR EACH ROW
  EXECUTE FUNCTION notify_module_unlocked();

-- 4. Certificado pronto
CREATE TRIGGER trigger_notify_certificate_ready
  AFTER INSERT OR UPDATE ON learning_certificates
  FOR EACH ROW
  EXECUTE FUNCTION notify_certificate_ready();

-- 5. Resposta em coment√°rio
CREATE TRIGGER trigger_notify_learning_comment_reply
  AFTER INSERT ON learning_comments
  FOR EACH ROW
  EXECUTE FUNCTION notify_learning_comment_reply();

-- 6. Conte√∫do atualizado
CREATE TRIGGER trigger_notify_course_content_updated
  AFTER UPDATE ON learning_lessons
  FOR EACH ROW
  EXECUTE FUNCTION notify_course_content_updated();
```

### Edge Functions

#### 1. **process-course-reminders**
```typescript
// Chamada via cron job diariamente
// URL: /functions/v1/process-course-reminders
// M√©todo: POST
// Body: {} (vazio)

// Identifica usu√°rios com cursos inacabados h√° 7+ dias
// Cria notifica√ß√µes autom√°ticas para engajamento
```

**Configura√ß√£o Cron:**
```bash
# Diariamente √†s 9h da manh√£
0 9 * * * curl -X POST https://seu-projeto.supabase.co/functions/v1/process-course-reminders \
  -H "Authorization: Bearer SEU_ANON_KEY"
```

#### 2. **check-course-milestones**
```typescript
// Chamada quando usu√°rio completa uma aula
// URL: /functions/v1/check-course-milestones
// M√©todo: POST
// Body: { user_id, course_id }

// Verifica se usu√°rio atingiu 25%, 50% ou 75% do curso
// Cria notifica√ß√£o de parabeniza√ß√£o
```

**Exemplo de uso no c√≥digo:**
```typescript
// Ap√≥s marcar aula como completa
await supabase.functions.invoke('check-course-milestones', {
  body: {
    user_id: user.id,
    course_id: courseId
  }
});
```

#### 3. **recommend-courses**
```typescript
// Chamada quando usu√°rio completa um curso ou periodicamente
// URL: /functions/v1/recommend-courses
// M√©todo: POST
// Body: { user_id, completed_course_id? }

// Analisa hist√≥rico e recomenda pr√≥ximos cursos
// Cria notifica√ß√µes de recomenda√ß√£o personalizadas
```

**Configura√ß√£o Cron (opcional):**
```bash
# Semanalmente aos domingos √†s 10h
0 10 * * 0 curl -X POST https://seu-projeto.supabase.co/functions/v1/recommend-courses \
  -H "Authorization: Bearer SEU_ANON_KEY" \
  -H "Content-Type: application/json" \
  -d '{"user_id": "BATCH_ALL_USERS"}'
```

### RPC Functions

```sql
-- 1. Processar lembretes de cursos
SELECT * FROM process_course_reminders();

-- 2. Verificar milestones de progresso
SELECT * FROM check_course_milestones(
  'user-uuid',
  'course-uuid'
);
```

## üìä Estrutura de Metadata

Cada notifica√ß√£o inclui metadata espec√≠fica do contexto:

### Novo Curso
```json
{
  "course_id": "uuid",
  "course_title": "string",
  "course_description": "string",
  "cover_image": "url"
}
```

### Nova Aula
```json
{
  "lesson_id": "uuid",
  "lesson_title": "string",
  "course_id": "uuid",
  "course_title": "string",
  "module_id": "uuid"
}
```

### Milestone
```json
{
  "course_id": "uuid",
  "course_title": "string",
  "milestone": 25 | 50 | 75,
  "progress_percentage": 52.5,
  "completed_lessons": 21,
  "total_lessons": 40
}
```

### Certificado
```json
{
  "certificate_id": "uuid",
  "course_id": "uuid",
  "course_title": "string",
  "certificate_url": "url",
  "validation_code": "string"
}
```

### Lembrete de Curso
```json
{
  "course_id": "uuid",
  "course_title": "string",
  "progress_percentage": 35.5,
  "days_since_last_access": 8
}
```

## üé® Exemplos de Notifica√ß√µes

### Novo Curso Publicado
```
T√≠tulo: "Novo Curso Dispon√≠vel: React Avan√ßado"
Mensagem: "Um novo curso foi publicado e est√° dispon√≠vel para voc√™ come√ßar agora!"
Categoria: learning
Prioridade: medium
```

### M√≥dulo Desbloqueado
```
T√≠tulo: "Novo M√≥dulo Desbloqueado! üéâ"
Mensagem: "Parab√©ns! Voc√™ desbloqueou o m√≥dulo: Hooks Avan√ßados"
Categoria: learning
Prioridade: high
```

### Certificado Pronto
```
T√≠tulo: "Certificado Dispon√≠vel! üéì"
Mensagem: "Seu certificado do curso 'React Avan√ßado' est√° pronto para download!"
Categoria: learning
Prioridade: high
```

### Lembrete de Curso
```
T√≠tulo: "Continue seu Progresso! üìö"
Mensagem: "Voc√™ est√° a 45% de completar: React Avan√ßado"
Categoria: learning
Prioridade: medium
```

### Milestone Atingido
```
T√≠tulo: "Marco Atingido: 50% Completo! üéØ"
Mensagem: "Parab√©ns! Voc√™ completou 50% do curso: React Avan√ßado"
Categoria: learning
Prioridade: medium
```

## üîç √çndices de Performance

```sql
-- Otimiza√ß√µes para queries frequentes
CREATE INDEX idx_learning_progress_user_updated 
  ON learning_progress(user_id, updated_at DESC);

CREATE INDEX idx_learning_progress_completed 
  ON learning_progress(user_id, lesson_id) WHERE completed = true;

CREATE INDEX idx_learning_comments_parent 
  ON learning_comments(parent_id) WHERE parent_id IS NOT NULL;
```

## üöÄ Como Usar

### Frontend - Hook de Notifica√ß√µes

```typescript
import { useNotificationsByCategory } from '@/hooks/useNotifications';

// Filtrar apenas notifica√ß√µes de learning
const { data: learningNotifications } = useNotificationsByCategory('learning');

// Agrupar por tipo
const groupedLearning = learningNotifications?.reduce((acc, notif) => {
  const type = notif.type;
  if (!acc[type]) acc[type] = [];
  acc[type].push(notif);
  return acc;
}, {});
```

### Backend - Chamar Edge Functions

```typescript
// Ao completar aula, verificar milestones
const handleLessonComplete = async (userId: string, courseId: string) => {
  // ... marcar aula como completa
  
  // Verificar milestones
  await supabase.functions.invoke('check-course-milestones', {
    body: { user_id: userId, course_id: courseId }
  });
};

// Ao completar curso, recomendar pr√≥ximo
const handleCourseComplete = async (userId: string, courseId: string) => {
  // ... gerar certificado
  
  // Recomendar pr√≥ximos cursos
  await supabase.functions.invoke('recommend-courses', {
    body: { 
      user_id: userId, 
      completed_course_id: courseId 
    }
  });
};
```

## ‚úÖ Checklist de Implementa√ß√£o

- [x] Triggers de banco de dados criados
- [x] Fun√ß√µes RPC implementadas
- [x] Edge Functions criadas
- [x] √çndices de performance adicionados
- [x] Documenta√ß√£o completa
- [ ] Testes de integra√ß√£o
- [ ] Configura√ß√£o de cron jobs em produ√ß√£o
- [ ] UI para exibir notifica√ß√µes de learning
- [ ] Deep links para navegar para conte√∫do relacionado

## üìà M√©tricas e Monitoramento

### KPIs Importantes

1. **Taxa de Engajamento:** % de usu√°rios que clicam em notifica√ß√µes de learning
2. **Taxa de Conclus√£o:** Impacto dos lembretes na conclus√£o de cursos
3. **Tempo de Resposta:** Velocidade de cria√ß√£o das notifica√ß√µes
4. **Volume:** Quantidade de notifica√ß√µes enviadas por dia/semana

### Queries de An√°lise

```sql
-- Notifica√ß√µes de learning por tipo (√∫ltimos 30 dias)
SELECT 
  type,
  COUNT(*) as total,
  COUNT(CASE WHEN read_at IS NOT NULL THEN 1 END) as read_count,
  ROUND(COUNT(CASE WHEN read_at IS NOT NULL THEN 1 END)::NUMERIC / COUNT(*) * 100, 2) as read_percentage
FROM notifications
WHERE category = 'learning'
  AND created_at > NOW() - INTERVAL '30 days'
GROUP BY type
ORDER BY total DESC;

-- Efetividade dos lembretes de curso
SELECT 
  (metadata->>'course_id')::UUID as course_id,
  metadata->>'course_title' as course_title,
  COUNT(*) as reminders_sent,
  COUNT(DISTINCT user_id) as unique_users
FROM notifications
WHERE type = 'learning_course_reminder'
  AND created_at > NOW() - INTERVAL '30 days'
GROUP BY course_id, metadata->>'course_title'
ORDER BY reminders_sent DESC;
```

## üéâ Conclus√£o

A Fase 3 est√° **100% implementada** e pronta para uso! O sistema agora cobre todos os eventos importantes do m√≥dulo de forma√ß√µes, desde a publica√ß√£o de novos cursos at√© a entrega de certificados e recomenda√ß√µes personalizadas.

**Pr√≥ximos Passos:** Fase 4 - Cobertura Comunidade
