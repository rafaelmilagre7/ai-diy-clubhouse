
import React, { useState, useEffect } from "react";
import { useForm, FormProvider } from "react-hook-form";
import { toast } from "sonner";
import { useOnboardingSteps } from "@/hooks/onboarding/useOnboardingSteps";
import { useNavigate } from "react-router-dom";
import { MilagrinhoMessage } from "@/components/onboarding/MilagrinhoMessage";
import { BusinessModelField } from "./inputs/BusinessModelField";
import { BusinessChallengesField } from "./inputs/BusinessChallengesField";
import { ShortTermGoalsField } from "./inputs/ShortTermGoalsField";
import { MediumTermGoalsField } from "./inputs/MediumTermGoalsField";
import { KpisField } from "./inputs/KpisField";
import { AdditionalContextField } from "./inputs/AdditionalContextField";
import { NavigationButtons } from "../NavigationButtons";
import { cn } from "@/lib/utils";

interface BusinessContextFormStepProps {
  progress: any;
  onSave?: (data: any) => void;
}

type BusinessContextFormValues = {
  business_model: string;
  business_challenges: string[];
  short_term_goals: string[];
  medium_term_goals: string[];
  important_kpis: string[];
  additional_context?: string;
};

export const BusinessContextFormStep: React.FC<BusinessContextFormStepProps> = ({ progress, onSave }) => {
  const { saveStepData } = useOnboardingSteps();
  const navigate = useNavigate();
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [lastAutoSave, setLastAutoSave] = useState<Date | null>(null);

  // Extrair valores iniciais de forma mais robusta
  const initialValues = {
    business_model: progress?.business_context?.business_model || "",
    business_challenges: progress?.business_context?.business_challenges || [],
    short_term_goals: progress?.business_context?.short_term_goals || [],
    medium_term_goals: progress?.business_context?.medium_term_goals || [],
    important_kpis: progress?.business_context?.important_kpis || [],
    additional_context: progress?.business_context?.additional_context || "",
  };

  console.log("Valores iniciais para Business Context:", initialValues);

  const methods = useForm<BusinessContextFormValues>({
    defaultValues: initialValues,
    mode: "onSubmit"
  });
  
  const { control, handleSubmit, formState: { errors, isDirty }, reset, getValues, watch } = methods;

  // Monitorar alteraÃ§Ãµes no formulÃ¡rio para debug
  const formValues = watch();
  useEffect(() => {
    console.log("Valores atuais do formulÃ¡rio:", formValues);
  }, [formValues]);

  // Atualizar o formulÃ¡rio quando os dados iniciais mudarem
  useEffect(() => {
    if (progress?.business_context) {
      console.log("Atualizando formulÃ¡rio com dados do contexto do negÃ³cio:", progress.business_context);
      reset({
        business_model: progress.business_context.business_model || "",
        business_challenges: progress.business_context.business_challenges || [],
        short_term_goals: progress.business_context.short_term_goals || [],
        medium_term_goals: progress.business_context.medium_term_goals || [],
        important_kpis: progress.business_context.important_kpis || [],
        additional_context: progress.business_context.additional_context || "",
      });
    }
  }, [progress, reset]);

  // Adicionar funÃ§Ã£o para salvar periodicamente dados do formulÃ¡rio
  useEffect(() => {
    // Salvar a cada 30 segundos se houver dados modificados
    const interval = setInterval(() => {
      if (isDirty) {
        const currentValues = getValues();
        // Verificar se hÃ¡ dados para salvar
        if (currentValues.business_model || 
            currentValues.business_challenges.length > 0 || 
            currentValues.short_term_goals.length > 0 || 
            currentValues.medium_term_goals.length > 0 || 
            currentValues.important_kpis.length > 0) {
          
          console.log("Auto-salvando dados do formulÃ¡rio:", currentValues);
          
          // Usar o callback de salvamento customizado se fornecido
          if (onSave) {
            onSave({
              business_context: currentValues
            });
          } else {
            saveStepData("business_context", {
              business_context: currentValues
            }, false).catch(err => 
              console.error("Erro no auto-save:", err)
            );
          }
          
          setLastAutoSave(new Date());
        }
      }
    }, 30000); // A cada 30 segundos
    
    return () => clearInterval(interval);
  }, [getValues, saveStepData, isDirty, onSave]);

  const onSubmit = async (data: BusinessContextFormValues) => {
    try {
      setIsSubmitting(true);
      console.log("Salvando dados de contexto de negÃ³cio:", data);
      
      // Usar o callback de salvamento customizado se fornecido
      if (onSave) {
        await onSave({
          business_context: {
            business_model: data.business_model,
            business_challenges: data.business_challenges,
            short_term_goals: data.short_term_goals,
            medium_term_goals: data.medium_term_goals,
            important_kpis: data.important_kpis,
            additional_context: data.additional_context,
          }
        });
      } else {
        // Salvamos com navegaÃ§Ã£o automÃ¡tica
        await saveStepData("business_context", {
          business_context: {
            business_model: data.business_model,
            business_challenges: data.business_challenges,
            short_term_goals: data.short_term_goals,
            medium_term_goals: data.medium_term_goals,
            important_kpis: data.important_kpis,
            additional_context: data.additional_context,
          }
        }, true);
      }
      
      toast.success("InformaÃ§Ãµes salvas com sucesso!");
    } catch (error) {
      console.error("Erro ao salvar dados:", error);
      toast.error("Erro ao salvar as informaÃ§Ãµes. Tente novamente.");
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <div className={cn("max-w-4xl mx-auto space-y-10", isSubmitting ? "opacity-60 pointer-events-none" : "")}>
      <MilagrinhoMessage
        message="Beleza, agora precisamos conhecer melhor o contexto do seu negÃ³cio no VIVER DE IA. ðŸ˜Š Isso vai me ajudar a identificar quais soluÃ§Ãµes de IA farÃ£o mais sentido para vocÃª. Como CEO, vocÃª vai adorar os conteÃºdos que temos especÃ­ficos para sua Ã¡rea de atuaÃ§Ã£o."
      />

      {lastAutoSave && (
        <div className="text-xs text-gray-500 italic">
          Ãšltimo salvamento automÃ¡tico: {lastAutoSave.toLocaleTimeString()}
        </div>
      )}

      <FormProvider {...methods}>
        <form onSubmit={handleSubmit(onSubmit)} className="flex flex-col gap-8">

          {/* Contexto do NegÃ³cio */}
          <section className="bg-white rounded-lg shadow p-6 space-y-4">
            <h2 className="text-xl font-semibold text-gray-900 flex items-center gap-2">
              <span className="inline-block text-[#0ABAB5]">ðŸ“‹</span>
              Contexto do NegÃ³cio
            </h2>
            <BusinessModelField control={control} error={errors.business_model} />
          </section>

          {/* Desafios e Objetivos */}
          <section className="bg-white rounded-lg shadow p-6 space-y-4">
            <h2 className="text-xl font-semibold text-gray-900 flex items-center gap-2">
              <span className="inline-block text-[#0ABAB5]">ðŸŽ¯</span>
              Desafios e Objetivos
            </h2>
            <BusinessChallengesField control={control} error={errors.business_challenges} />
            <ShortTermGoalsField control={control} error={errors.short_term_goals} />
            <MediumTermGoalsField control={control} error={errors.medium_term_goals} />
          </section>

          {/* KPIs */}
          <section className="bg-white rounded-lg shadow p-6 space-y-4">
            <h2 className="text-xl font-semibold text-gray-900 flex items-center gap-2">
              <span className="inline-block text-[#0ABAB5]">ðŸ“ˆ</span>
              Indicadores de Performance
            </h2>
            <KpisField control={control} error={errors.important_kpis} />
            <AdditionalContextField control={control} />
          </section>

          {/* NavegaÃ§Ã£o */}
          <NavigationButtons 
            isSubmitting={isSubmitting} 
            onPrevious={() => navigate("/onboarding/professional-data")} 
          />
        </form>
      </FormProvider>
    </div>
  );
};
